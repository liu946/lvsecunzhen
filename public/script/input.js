// Generated by CoffeeScript 1.9.3
var getDBvalue, getformvalue, getinputname, getkeyvalue, inputs, putmodel, value;

getkeyvalue = function(url) {
  return $.ajax({
    url: url,
    dataType: 'json',
    async: false
  }).done(function(data) {
    return data;
  }).fail(function() {
    return alert("获取失败！请刷新页面");
  }).always(function() {
    return console.log("complete");
  });
};

getDBvalue = function(url, array) {
  return $.ajax({
    url: url,
    dataType: 'json',
    async: true
  }).done(function(data) {
    var a, b, k, v;
    for (k in data) {
      v = data[k];
      if (k === 'id') {
        continue;
      }
      a = $("#" + k);
      if (a.length > 0) {
        $("#" + k).val(v);
      } else {
        b = $("input." + k + "[value='" + v + "']");
        b.prop('checked', true);
        if (b.attr('class').split(' ')[1] === 'other') {
          $("#" + k + "_other").val(v).css('display', 'inline-block');
        }
      }
    }
  }).fail(function() {
    return alert("数据库获取数据失败");
  }).always(function() {
    return console.log('DB_connect');
  });
};

putmodel = function(object, inputs) {
  var b, data, fieldid, fieldname, html, i, id, items, j, k, l, len, len1, m, mend, ref, str, type, unit, v;
  html = "";
  id = object["class"];
  html = "<div id='" + id + "' class='content'>";
  ref = object.childfield;
  for (j = 0, len = ref.length; j < len; j++) {
    b = ref[j];
    fieldname = b.fieldname;
    fieldid = b.field;
    type = b.type;
    unit = b.unit;
    items = b.items;
    inputs = getinputname(fieldid, inputs);
    mend = '';
    if (unit === void 0) {
      unit = '';
    }
    if (type === 'time') {
      str = "<ul class='yearinput'>";
      for (i = l = 1985; l <= 2016; i = l += 1) {
        str += "<li> <div class='content'><p>" + i + "</p></div> <div class='datavalue'><input type='text' id='" + i + "' name='" + fieldname + "_" + i + "'>" + unit + "</div> </li>";
        mend = "style='height:1049px'";
      }
      str += "</ul>";
    } else if (type === 'list') {
      str = "<select name='" + fieldname + "' id='" + fieldid + "'>";
      data = getkeyvalue("/get/" + modelname);
      for (m = 0, len1 = data.length; m < len1; m++) {
        i = data[m];
        str += "<option value='i'>" + i + "</option>";
      }
      str += "</select>";
    } else if (items !== void 0) {
      str = "";
      for (k in items) {
        v = items[k];
        str += "<input type='radio' class='" + fieldid + "' name='" + fieldid + "' value='" + k + "' />" + v;
      }
    } else {
      str = "<input type='text' id='" + fieldid + "' name='" + fieldid + "' />" + unit;
      mend = '';
    }
    html += "<div class='list' " + mend + "> <div class='note'> <h3>" + fieldname + "</h3> </div> <div class='input'> " + str + " </div> </div>";
  }
  html += "</div><hr />";
  $('#J_form').append(html);
  return inputs;
};

getinputname = function(value, target) {
  var a, j, len;
  for (j = 0, len = target.length; j < len; j++) {
    a = target[j];
    if (a === value) {
      return target;
    }
  }
  target.push(value);
  return target;
};

getformvalue = function(array) {
  var data, flag, i, j, len, target, targetvalue;
  data = {
    "id": id
  };
  flag = 0;
  for (j = 0, len = array.length; j < len; j++) {
    i = array[j];
    target = i;
    targetvalue = $("input[name=" + target + "]").val();
    if (targetvalue === '') {
      flag = 1;
    }
    data[target] = targetvalue;
  }
  return {
    data: data,
    flag: flag
  };
};

value = JSON.parse(getkeyvalue('/input/field').responseText);

value = value[modelname];

inputs = [];

inputs = putmodel(value, inputs);

$('.submit').on('click', function() {
  var target;
  target = getformvalue(inputs);
  value = target.data;
  if (target.flag) {
    return alert("没有填写完整，请检查");
  } else {
    return $.post("/input/insert/" + modelname, value, function(data) {
      return console.log(data);
    });
  }
});
